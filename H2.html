
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Stream Player</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">

    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Premium blue theme */
            --bg-color: #0b1830;
            --header-pill: linear-gradient(180deg,#0d2a5a,#0a1f44);
            --panel-bg: linear-gradient(180deg,#0d2a5a,#0a224c);
            --panel-border: #153568;
            --accent: #1e78ff;
            --accent-2: #78a6ff;
            --text-light: #eaf2ff;
            --text-muted: #b9cae6;
            --card-bg: #0f223f;
            --border-color: #153568;
            --popup-bg: #0f223f;
            --popup-shadow-color: rgba(30, 120, 255, 0.35);
            --danger: #e50914;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 800px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .stream-header {
            background: var(--header-pill);
            border: 1px solid var(--panel-border);
            padding: 0.9rem 1.25rem;
            border-radius: 999px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 1rem;
            max-width: 900px;
            box-shadow: 0 8px 28px rgba(10,31,68,0.35);
        }
        .stream-header h1 { font-size: 1.1rem; font-weight: 600; color: var(--text-light); letter-spacing: .3px; }
        .live-badge {
            background: radial-gradient(100% 100% at 50% 0%, #ff3b3b 0%, #ba1a1a 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-left: .6rem;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(229, 9, 20, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(229, 9, 20, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(229, 9, 20, 0); }
        }
        #player-container {
            width: 100%;
            height: 52vh;
            max-height: 660px;
            background-color: #000;
            box-shadow: 0 18px 38px rgba(10,31,68,0.45);
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid var(--panel-border);
            position: relative;
            transition: all 0.3s ease;
        }
        /* CSS FROM NEW FILE: Hide shaka spinner completely */
        .shaka-spinner-container,
        .shaka-spinner,
        .shaka-spinner-svg {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        .grid-panels { display: grid; gap: 1rem; grid-template-columns: 1fr; }
        @media (min-width: 900px) { .grid-panels { grid-template-columns: 1fr 1fr; } }
        .info-card {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 14px;
            padding: 1.25rem;
            margin-top: 1rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(10,31,68,0.35);
        }
        .info-card h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-muted);
        }
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 10px;
            background: linear-gradient(180deg, var(--accent), var(--accent-2));
            color: #02122b;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px var(--popup-shadow-color);
        }
        .action-button.copied { background: linear-gradient(90deg, #22c55e, #a5f3ac); color: #05230f; }
        .back-link {
            display: inline-block;
            width: 100%;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-muted);
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        .back-link:hover { background-color: var(--card-bg); color: var(--text-light); }
        .error-message {
             text-align: center;
             padding: 4rem 1rem;
             background-color: var(--card-bg);
             border: 1px solid var(--border-color);
             border-radius: 12px;
        }
        .error-message h2 { color: var(--danger); font-size: 1.5rem; margin-bottom: 0.5rem; }
        .telegram-popup {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--popup-bg); color: var(--text-light);
            padding: 30px 20px; border-radius: 12px;
            box-shadow: 0 0 50px 10px var(--popup-shadow-color);
            z-index: 10000; text-align: center;
            width: 90%; max-width: 350px;
            display: none; border: 1px solid var(--primary-red-dark);
            animation: popIn 0.3s ease-out forwards;
        }
        @keyframes popIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .telegram-popup h2 { margin-top: 0; color: var(--primary-red); font-size: 1.5rem; margin-bottom: 0.5rem; }
        .telegram-popup p { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem; }
        .telegram-popup button {
            width: 100%; padding: 12px;
            margin-top: 12px; font-size: 1rem;
            border: none; border-radius: 6px;
            cursor: pointer; font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .telegram-popup button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }
        .telegram-popup .join-btn { background: linear-gradient(90deg, var(--primary-red), var(--primary-red-dark)); color: white; }
        .telegram-popup .joined-btn { background-color: var(--border-color); color: var(--text-light); }
        @media (max-width: 480px) {
            body { padding: 0.5rem; }
            .telegram-popup { padding: 20px 15px; }
        }
    </style>
</head>
<body>
    <main class="container">
        <div id="stream-content"></div>
    </main>
    <div class="telegram-popup" id="telegramPopup">
        <h2><i class="fa-brands fa-telegram"></i> Support Us!</h2>
        <p>Join our Telegram channel <strong>FinallyLive</strong> for instant updates, highlights, and exclusive links.</p>
        <a href="https://telegram.me/Finally_live_streaming" target="_blank" rel="noopener"><button class="join-btn">Join Now</button></a>
        <button class="joined-btn" onclick="document.getElementById('telegramPopup').style.display='none';">Already Joined</button>
    </div>

    <script>
        // --- SCRIPT MODIFIED WITH NEW SHAKA PLAYER (v4.7.11) ---

        document.addEventListener("shaka-ui-loaded", initializeApp);
        document.addEventListener("shaka-ui-load-failed", (error) => console.error("Shaka UI failed to load.", error));

        async function initializeApp() {
            // Added from new player
            shaka.polyfill.installAll();
            if (!shaka.Player.isBrowserSupported()) {
                console.error('Browser not supported');
                renderErrorUI("Browser Not Supported", "Your browser does not support the required features for this video player.");
                return;
            }

            try {
                // Step 1: Fetch the new json file
                const response = await fetch('https://raw.githubusercontent.com/Cricketstan/Allrounder-/refs/heads/main/id.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const streams = await response.json();

                // Step 2: Run the player logic after streams are loaded
                const urlParams = new URLSearchParams(window.location.search);
                const streamId = urlParams.get('id');
                
                // --- LOGIC UPDATED FOR NEW JSON STRUCTURE ---
                // Find the stream object in the 'iframes' array by its 'id'
                const streamData = streams.iframes.find(stream => stream.id === streamId);
                
                if (streamData) {
                    document.title = `${streamData.name} // Live Stream`;

                    if (streamData.type === 'iframe') {
                        renderIframeUI(streamData);
                    } else {
                        renderPlayerUI(streamData);
                        // Call the NEW initShakaPlayer function
                        initShakaPlayer(streamData);
                    }
                    
                    setTimeout(() => { document.getElementById('telegramPopup').style.display = 'block'; }, 1000);
                } else {
                    renderErrorUI("Stream Not Found", "The requested stream ID is invalid, the stream is offline, or the configuration file could not be loaded.");
                }

            } catch (error) {
                console.error("Failed to fetch or process streams.json:", error);
                renderErrorUI("Failed to Load", "Could not load the stream configuration. Please try again later.");
            }
        }

        function renderIframeUI(data) {
            const contentDiv = document.getElementById('stream-content');
            contentDiv.innerHTML = `
                <div class="stream-header"><h1>${data.name}</h1><span class="live-badge"><i class="fa-solid fa-circle"></i> LIVE</span></div>
                <div id="player-container">
                    <iframe 
                        src="${data.iframeSrc}" 
                        style="width:100%; height:100%; border:0;" 
                        allow="encrypted-media; autoplay" 
                        allowfullscreen>
                    </iframe>
                </div>
                <div class="grid-panels">
                    <div class="info-card"><h2><i class="fa-solid fa-bell"></i> Follow us for Updates!</h2><a href="https://t.me/+e9BLe1TuBBIxN2U1" target="_blank" rel="noopener" class="action-button"><i class="fa-brands fa-telegram"></i> Click Here To Join Telegram</a></div>
                    <div class="info-card"><h2><i class="fa-solid fa-link"></i> Copy Link & Share</h2><button class="action-button" id="shareButton"><i class="fa-solid fa-share-nodes"></i> Click Here To Share This Page Link</button></div>
                </div>
                <a href="#" class="back-link"><i class="fa-solid fa-arrow-left"></i> Back to All Streams</a>
            `;
            document.getElementById('shareButton').addEventListener('click', copyAndShare);
        }

        // renderPlayerUI simplified to remove old custom controls
        function renderPlayerUI(data) {
            const contentDiv = document.getElementById('stream-content');
            contentDiv.innerHTML = `
                <div class="stream-header"><h1>${data.name}</h1><span class="live-badge"><i class="fa-solid fa-circle"></i> LIVE</span></div>
                
                <div id="player-container" data-shaka-player-container>
                    <video id="video-player" style="width:100%;height:100%;" autoplay playsinline preload="auto" data-shaka-player></video>
                </div>

                <div class="grid-panels">
                    <div class="info-card"><h2><i class="fa-solid fa-bell"></i> Follow us for Updates!</h2><a href="https://t.me/+e9BLe1TuBBIxN2U1" target="_blank" rel="noopener" class="action-button"><i class="fa-brands fa-telegram"></i> Click Here To Join Telegram</a></div>
                    <div class="info-card"><h2><i class="fa-solid fa-link"></i> Copy Link & Share</h2><button class="action-button" id="shareButton"><i class="fa-solid fa-share-nodes"></i> Click Here To Share This Page Link</button></div>
                </div>
                <a href="#" class="back-link"><i class="fa-solid fa-arrow-left"></i> Back to All Streams</a>
            `;
            document.getElementById('shareButton').addEventListener('click', copyAndShare);
        }
        
        function renderErrorUI(title = "Stream Not Found", message = "The requested stream is unavailable.") {
            const contentDiv = document.getElementById('stream-content');
            document.title = `Error - ${title}`;
            contentDiv.innerHTML = `<div class="error-message"><h2><i class="fa-solid fa-triangle-exclamation"></i> ${title}</h2><p>${message}</p><a href="#" class="back-link" style="margin-top: 2rem;"><i class="fa-solid fa-arrow-left"></i> Back to All Streams</a></div>`;
        }

        // ========== NEW SHAKA PLAYER (v4.7.11) LOGIC ==========
        // This function replaces the old initShakaPlayer
        async function initShakaPlayer(data) {
            const video = document.getElementById('video-player');
            const container = document.getElementById('player-container');
            if (!video || !container) return;
            
            const player = new shaka.Player();
            await player.attach(video);

            const ui = new shaka.ui.Overlay(player, container, video);

            // UI config from new file
            ui.configure({
                controlPanelElements: [
                    'play_pause', 'time_and_duration', 'mute', 'volume',
                    'spacer', 'language', 'captions', 'picture_in_picture',
                    'quality', 'fullscreen'
                ],
                // Using accent colors from this file's theme
                volumeBarColors: { base: 'rgba(255, 255, 255, 0.3)', level: 'var(--accent)' },
                seekBarColors:   { base: 'rgba(255, 255, 255, 0.3)', buffered: 'rgba(255, 255, 255, 0.5)', played: 'var(--accent)' }
            });

            // --- Dynamic Data Configuration ---
            // Using the 'data' object from streams.json instead of hardcoded values
            let drmConfig = data.keyId ? { clearKeys: { [data.keyId]: data.key } } : {};
            let license = data.license; // { cookie, referer, userAgent }
            let streamUrl = data.mpd;
            // ----------------------------------

            // Player config from new file
            player.configure({
                drm: drmConfig,
                streaming: {
                    lowLatencyMode: true,
                    bufferingGoal: 15,
                    rebufferingGoal: 2,
                    bufferBehind: 15,
                    retryParameters: {
                        timeout: 10000,
                        maxAttempts: 5,
                        baseDelay: 300,
                        backoffFactor: 1.2
                    },
                    segmentRequestTimeout: 8000,
                    segmentPrefetchLimit: 2,
                    useNativeHlsOnSafari: true
                },
                manifest: {
                    retryParameters: {
                        timeout: 8000,
                        maxAttempts: 3
                    }
                }
            });

            // Network filter using dynamic 'license' data
            if (license) {
                player.getNetworkingEngine().registerRequestFilter((type, request) => {
                    if (license.referer) request.headers['Referer'] = license.referer;
                    if (license.userAgent) request.headers['User-Agent'] = license.userAgent;
                    
                    if (license.cookie) {
                        request.headers['Cookie'] = license.cookie;
                        // Appending cookie as query param (logic from both files)
                        if (
                            (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                            type === shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
                            request.uris[0] && !request.uris[0].includes('__hdnea=') // Check from new file
                        ) {
                            const separator = request.uris[0].includes('?') ? '&' : '?';
                            request.uris[0] += separator + license.cookie;
                        }
                    }
                });
            }

            // --- Event Listeners & Autoplay (from new file) ---
            const enableAutoplay = () => {
                video.setAttribute('autoplay', '');
                video.setAttribute('playsinline', '');
                video.autoplay = true;
            };

            const attemptAutoplay = async () => {
                try {
                    video.muted = false;
                    await video.play();
                    return true;
                } catch (error) {
                    try {
                        video.muted = true;
                        await video.play();
                        return true;
                    } catch {
                        return false;
                    }
                }
            };

            player.addEventListener('error', (event) => {
                console.error('Shaka Player Error:', event.detail);
            });

            video.addEventListener('play', () => {
                if (window.self === window.top && !document.fullscreenElement && window.innerWidth <= 768) {
                    container.requestFullscreen().catch(() => {});
                }
            }, { once: true });

            video.addEventListener('loadedmetadata', () => {
                video.volume = 0.8;
            });

            let hasUserInteracted = false;
            const enableSoundOnInteraction = () => {
                if (!hasUserInteracted && video.muted) {
                    video.muted = false;
                    hasUserInteracted = true;
                }
            };
            ['click', 'touchstart', 'keydown'].forEach(event => {
                document.addEventListener(event, enableSoundOnInteraction, { once: true });
            });

            try {
                enableAutoplay();
                await player.load(streamUrl);
                if (video.readyState >= 3) {
                    await attemptAutoplay();
                } else {
                    video.addEventListener('canplay', attemptAutoplay, { once: true });
                    setTimeout(async () => {
                        if (video.paused) await attemptAutoplay();
                    }, 2000);
                }
            } catch (error) {
                console.error('Load error:', error);
            }

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && video.paused) attemptAutoplay();
            });
        }
        // ========== END OF NEW SHAKA PLAYER LOGIC ==========

        
        async function copyAndShare() {
            const shareButton = document.getElementById('shareButton');
            const originalHTML = shareButton.innerHTML;
            try {
                await navigator.clipboard.writeText(window.location.href);
                shareButton.innerHTML = `<i class="fa-solid fa-check"></i> Link Copied!`;
                shareButton.classList.add('copied');
                setTimeout(() => { shareButton.innerHTML = originalHTML; shareButton.classList.remove('copied'); }, 2000);
            } catch (err) { console.error('Failed to copy link:', err); }
        }
    </script>
    
    <script disable-devtool-auto src='https://cdn.jsdelivr.net/npm/disable-devtool'></script>
</body>
</html>

